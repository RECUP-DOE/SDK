name: CI tests for RECUP components
on:
  # https://docs.github.com/en/rest/repos/repos#create-a-repository-dispatch-event
  repository_dispatch:
    types: [ ci-on-demand ]
  # https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#schedule
  # schedule:
  #   - cron: '30 10 * * *'


jobs:

  tests-pip:
    name: Tests with PIP package manager
    runs-on: ubuntu-latest
    env:
      ENV_NAME: recup-env
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    - uses: actions/setup-python@v5
      with:
        python-version: 3.10
    - name: Create environment
      run: |
        python -m venv ${{ env.ENV_NAME }}
        . ${{ env.ENV_NAME }}/bin/activate
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install -r ./requirements/pip.txt
        python -m pip cache purge
    - name: Test RADICAL tools
      run: |
        . ${{ env.ENV_NAME }}/bin/activate
        for component in radical-tools; do
          bash -c tests/${component}/test.sh";
        done

  tests-spack:
    name: Tests with SPACK package manager
    runs-on: ubuntu-latest
    env:
      ENV_NAME: recup-env
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    - uses: spack/setup-spack@v2
      with:
        ref: develop      # Spack version (examples: develop, releases/v0.23)
        buildcache: true  # Configure oci://ghcr.io/spack/github-actions-buildcache
        path: spack       # Where to clone Spack
    - name: Create environment
      shell: spack-bash {0}
      run: |
        spack env create ${{ env.ENV_NAME }}
        spack env activate ${{ env.ENV_NAME }}
        spack config add concretizer:unify:when_possible
        spack config add concretizer:reuse:false
        spack config add config:db_lock_timeout:300
        spack -e ./requirements concretize
        spack -e ./requirements install
    - name: Test tools
      shell: spack-bash {0}
      run: |
        spack env activate ${{ env.ENV_NAME }}
        spack env status

